<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiHogar</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<style>
    .container-form {
        margin-top: 10vh;
        display: grid;
        justify-content: center;
    }

    .incidence-form {
        max-width: 30vw;
        align-content: center;
    }
</style>

<body>
    <div class="container-form">
        <h1>Formulario de incidencias</h1>
        <form class="incidence-form">
            <div class="mb-3">
                <label for="community-RUT">RUT de la comunidad</label>
                <input class="form-control" id="input-RUT-community" disabled>
            </div>
            <div class="mb-3">
                <label for="user-RUT">RUT *</label>
                <input class="form-control" id="input-RUT""
                    placeholder="Introduce el RUT" maxlength="7" minlength="7" required>
            </div>
            <div class="mb-3">
                <label for="select-incidence-type" class="form-label">Tipo de Incidencia *</label>
                <select class="form-select" id="incidence-type" name="incidence" required>
                    <option value="">Selecciona una opción</option>
                    <option value="Averías en instalaciones comunes">Averías en instalaciones comunes</option>
                    <option value="Limpieza y mantenimiento">Limpieza y mantenimiento</option>
                    <option value="Ruido y comportamiento">Ruido y comportamiento</option>
                    <option value="Seguridad">Seguridad</option>
                    <option value="Mascotas">Mascotas</option>
                    <option value="Obras y reformas">Obras y reformas</option>
                    <option value="Gestión de residuos">Gestión de residuos</option>
                    <option value="Incidencias de viviendas">Incidencias de viviendas</option>
                    <option value="Iluminaciónn y señalización">Iluminación y señalización</option>
                    <option value="Comunicación">Comunicación</option>
                    <option value="Pagos y facturación">Pagos y facturación</option>
                    <option value="Accesibilidad">Accesibilidad</option>
                    <option value="Emergencias">Emergencias</option>
                    <option value="Control de plagas">Control de plagas</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="observations" class="form-label">Observaciones *</label>
                <textarea class="form-control" id="observations" name="observations" rows="4"
                    placeholder="Introduce tus observaciones" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
    </div>
</body>
<script>
    var uri = window.location.href;
    var index = uri.indexOf('?');

    if (index !== -1 && index < uri.length - 1) {

        var charactersAfterQuestionMark = uri.substring(index + 1);
        document.getElementById("input-RUT-community").value = charactersAfterQuestionMark;
    }

    document.addEventListener("DOMContentLoaded", function () {
        var form = document.querySelector('.incidence-form');

        form.addEventListener("submit", function (event) {
            event.preventDefault();

            var rutComunidad = document.getElementById('input-RUT-community').value;
            var rut = document.getElementById('input-RUT').value;
            var tipoIncidencia = document.getElementById('incidence-type').value;
            var observaciones = document.getElementById('observations').value;

            var data = {
                "RUT de la Comunidad": rutComunidad,
                "RUT": rut,
                "Tipo de incidencia": tipoIncidencia,
                "Observaciones": observaciones
            };

            fetch("https://prod-101.westeurope.logic.azure.com:443/workflows/6d5c6f9163ac4a42ba46302aac178226/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JucUd78MxMMU22GcfECBWt7k6wr5rLi4kwNAdfKyH7E", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 502) {
                            throw new Error('usuario no registrado');
                        } else {
                            throw new Error('error en la solicitud');
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    alert("Datos enviados correctamente: " + JSON.stringify(data));
                    form.reset();
                })
                .catch(error => {
                    alert("Error al enviar datos: " + error.message);
                });
        });
    });
</script>

</html>